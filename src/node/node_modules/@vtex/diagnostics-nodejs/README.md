# OpenTelemetry Diagnostics Library for Node.js

A Node.js library that simplifies telemetry collection using OpenTelemetry, providing unified interfaces for metrics, logs, and traces.

## Installation

```bash
npm install @vtex/diagnostics
```

## Quick Start

Here's how to set up basic telemetry for your Node.js application:

```javascript
const { NewTelemetryClient, Exporters, TelemetryType } = require('@vtex/diagnostics');

async function main() {
  // Initialize the central telemetry client
  const telemetryClient = await NewTelemetryClient(
    'my-client',
    'my-service'
  );

  // Create an exporter for traces
  const tracesConfig = Exporters.CreateTracesExporterConfig({
    endpoint: 'localhost:4317',
    protocol: 'grpc'
  });
  const tracesExporter = Exporters.CreateExporter(tracesConfig, 'otlp');

  // Initialize traces client
  const tracesClient = await telemetryClient.newTracesClient({
    exporter: tracesExporter,
    setGlobalProvider: true
  });

  // Start tracing
  const span = tracesClient.startSpan('my-operation');
  
  try {
    // Your business logic here
    span.setAttributes({ 'my.attribute': 'value' });
    
    // Record an event
    span.addEvent('processing-started');
    
    // Create a child span for a sub-operation
    const childSpan = tracesClient.startSpan('sub-operation');
    // ... more logic
    childSpan.end();
  } catch (error) {
    span.recordError(error);
    throw error;
  } finally {
    span.end();
  }

  // Graceful shutdown
  await tracesClient.shutdown();
}

main().catch(console.error);
```

## Metrics Example

```javascript
const { NewTelemetryClient, Exporters, TelemetryType } = require('@vtex/diagnostics');

async function setupMetrics() {
  const telemetryClient = await NewTelemetryClient('metrics-client', 'my-service');
  
  const metricsConfig = Exporters.CreateMetricsExporterConfig({
    endpoint: 'localhost:4317'
  });
  const metricsExporter = Exporters.CreateExporter(metricsConfig, 'otlp');
  
  const metricsClient = await telemetryClient.newMetricsClient({
    exporter: metricsExporter
  });

  // Create a counter
  const requestCounter = metricsClient.counter('http_requests_total', [
    { description: 'Total HTTP requests processed' },
    { unit: '1' }
  ]);

  // Create a histogram with custom buckets
  const responseTimeHistogram = metricsClient.histogram('response_time_seconds', [
    { description: 'HTTP response time' },
    { unit: 's' },
    { buckets: [0.01, 0.05, 0.1, 0.5, 1, 5] }
  ]);

  return { metricsClient, requestCounter, responseTimeHistogram };
}
```

## Logging Example

```javascript
const { NewTelemetryClient, Exporters, TelemetryType } = require('@vtex/diagnostics');

async function setupLogging() {
  const telemetryClient = await NewTelemetryClient('logs-client', 'my-service');
  
  const logsConfig = Exporters.CreateLogsExporterConfig({
    endpoint: 'localhost:4317'
  });
  const logsExporter = Exporters.CreateExporter(logsConfig, 'otlp');
  
  const logsClient = await telemetryClient.newLogsClient({
    exporter: logsExporter
  });

  // Log different levels
  logsClient.info('Application started', { version: '1.0.0' });
  logsClient.warn('Resource usage high', { cpu: 0.85 });
  
  try {
    // Some operation that might fail
    throw new Error('Database connection failed');
  } catch (err) {
    logsClient.error('Operation failed', { error: err.message });
  }

  return logsClient;
}
```

## Testing

To test this library locally, you can run a local LGTM (Loki, Grafana, Tempo and Mimir) stack

```bash
# Run the LGTM stack with docker
cd examples/lgtm
make lgtm-up
```

Then run the sample project that imports the nodejs lib

```bash
cd examples/nodejs/nodejs-server
docker-compose up
```

Now your able to play around with the available endpoints from the nodejs-server to generate metrics and traces.

The exported telemetry will be sent to your local collector for inspection.

## Environment Variables

The library respects standard OpenTelemetry environment variables and adds some extras:

```
# Basic configuration
SERVICE_NAME=my-service
SERVICE_VERSION=1.0.0
DEPLOYMENT_ENVIRONMENT=production

# Export configuration
OTEL_EXPORTER_OTLP_ENDPOINT=https://collector.example.com:4317
OTEL_EXPORTER_OTLP_PROTOCOL=grpc
```

For complete documentation, see our [detailed API docs](https://link-to-your-docs).
