"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VtexAttributesSpanProcessor = void 0;
const api_1 = require("@opentelemetry/api");
const constants_1 = require("./constants");
const utils_1 = require("./utils");
class VtexAttributesSpanProcessor {
    constructor(nextProcessor) {
        this._nextProcessor = nextProcessor;
    }
    forceFlush() {
        if (this._nextProcessor) {
            return this._nextProcessor.forceFlush();
        }
        return Promise.resolve();
    }
    shutdown() {
        if (this._nextProcessor) {
            return this._nextProcessor.shutdown();
        }
        return Promise.resolve();
    }
    onStart(span, parentContext) {
        if (this._nextProcessor) {
            this._nextProcessor.onStart(span, parentContext);
        }
        if (!span.isRecording()) {
            return;
        }
        const headers = (0, utils_1.extractHeadersFromSpan)(span);
        const operationId = headers[constants_1.HeaderKeys.VTEX_OPERATION_ID.toLowerCase()];
        if (operationId) {
            const baggage = api_1.propagation.getBaggage(parentContext) || api_1.propagation.createBaggage();
            const updatedBaggage = baggage.setEntry(constants_1.AttributeKeys.VTEX_OPERATION_ID, { value: operationId });
            api_1.propagation.setBaggage(parentContext, updatedBaggage);
            span.setAttribute(constants_1.AttributeKeys.VTEX_OPERATION_ID, operationId);
        }
        const accountName = span.attributes?.[constants_1.AttributeKeys.VTEX_ACCOUNT_NAME];
        if (accountName && typeof accountName === 'string') {
            const baggage = api_1.propagation.getBaggage(parentContext) || api_1.propagation.createBaggage();
            const updatedBaggage = baggage.setEntry(constants_1.AttributeKeys.VTEX_ACCOUNT_NAME, { value: accountName });
            api_1.propagation.setBaggage(parentContext, updatedBaggage);
        }
        (0, utils_1.enhanceWithHTTPData)(span, headers, (0, utils_1.extractStatusCodeFromSpan)(span));
        (0, utils_1.enhanceWithVTEXData)(span, headers);
    }
    onEnd(span) {
        if (this._nextProcessor) {
            this._nextProcessor.onEnd(span);
        }
    }
}
exports.VtexAttributesSpanProcessor = VtexAttributesSpanProcessor;
//# sourceMappingURL=span-processor.js.map